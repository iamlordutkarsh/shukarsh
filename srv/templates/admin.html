<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Admin ‚úø Shukarsh</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Nunito:wght@400;600;700;800&family=Satisfy&display=swap" rel="stylesheet">
<style>
:root{--p:#a78bca;--pl:#c9b3e8;--pd:#8b6aae;--pp:#f0eaf8;--lav:#c9b3e8;--bg:#faf0e4;--bg2:#f3e4d0;--tx:#2c2137;--txl:#6b5e7b;--w:#fff;--r:16px;--green:#4caf50;--red:#e53935}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Nunito',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh}
a{text-decoration:none;color:inherit}img{display:block}

nav{position:sticky;top:0;z-index:100;background:rgba(250,240,228,.92);backdrop-filter:blur(20px);padding:16px 24px;border-bottom:2px solid rgba(167,139,202,.08)}
.nav-inner{max-width:960px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
.logo{font-family:'Satisfy',cursive;font-size:1.8rem;color:var(--p)}
.logo span{color:var(--pd)}
.back-btn{padding:8px 20px;border:2px solid var(--pl);border-radius:50px;font-size:.8rem;font-weight:700;color:var(--p);transition:all .3s}
.back-btn:hover{background:var(--p);color:var(--w)}

.container{max-width:960px;margin:0 auto;padding:40px 24px}
h1{font-family:'DM Serif Display',serif;font-size:2rem;margin-bottom:8px}
h1 i{font-family:'Satisfy',cursive;color:var(--p);font-style:normal}
.subtitle{color:var(--txl);margin-bottom:32px}

.tabs{display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap}
.tab{padding:10px 24px;border-radius:50px;font-weight:700;font-size:.85rem;cursor:pointer;border:2px solid var(--pl);color:var(--p);background:var(--w);transition:all .3s}
.tab.active{background:linear-gradient(135deg,var(--p),var(--pd));color:var(--w);border-color:var(--p)}

.add-box{background:var(--w);border-radius:var(--r);padding:28px;box-shadow:0 4px 20px rgba(167,139,202,.08);margin-bottom:40px}
.add-box h2{font-family:'DM Serif Display',serif;font-size:1.3rem;margin-bottom:16px}
.form-row{display:flex;gap:12px;margin-bottom:12px}
input[type=text],input[type=url],textarea,select{width:100%;padding:13px 18px;border:2px solid rgba(167,139,202,.15);border-radius:12px;font-family:'Nunito',sans-serif;font-size:.92rem;outline:none;transition:border-color .3s;color:var(--tx);background:var(--w)}
input:focus,textarea:focus,select:focus{border-color:var(--p)}
input::placeholder,textarea::placeholder{color:var(--pl)}
textarea{resize:vertical;min-height:60px}
.btn{padding:13px 28px;background:linear-gradient(135deg,var(--p),var(--pd));color:var(--w);border:none;border-radius:12px;font-family:'Nunito',sans-serif;font-size:.9rem;font-weight:800;cursor:pointer;transition:all .3s;white-space:nowrap}
.btn:hover{transform:scale(1.03);box-shadow:0 6px 20px rgba(167,139,202,.3)}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
.btn-sm{padding:8px 16px;font-size:.78rem;border-radius:10px}
.btn-outline{background:none;border:2px solid var(--pl);color:var(--p)}
.btn-outline:hover{background:var(--pp)}
.btn-danger{background:linear-gradient(135deg,var(--red),#c62828)}
.btn-danger:hover{box-shadow:0 6px 20px rgba(229,57,53,.3)}

.msg{padding:12px 18px;border-radius:10px;margin-top:14px;font-size:.9rem;font-weight:600;display:none}
.msg.ok{display:block;background:#e8f5e9;color:#2e7d32}
.msg.err{display:block;background:#fce4ec;color:#c62828}
.msg.loading{display:block;background:var(--pp);color:var(--p)}

.panel{display:none}
.panel.active{display:block}
.field-label{font-size:.8rem;font-weight:700;color:var(--txl);margin-bottom:4px;display:block}
.field-group{margin-bottom:14px}
.hint{font-size:.8rem;color:var(--txl);margin-top:8px;line-height:1.6}

/* PRODUCT LIST */
.prod-list h2{font-family:'DM Serif Display',serif;font-size:1.3rem;margin-bottom:16px}
.prod-card{background:var(--w);border-radius:16px;padding:18px;margin-bottom:14px;box-shadow:0 2px 12px rgba(0,0,0,.04);transition:all .3s}
.prod-card:hover{box-shadow:0 6px 24px rgba(167,139,202,.12)}
.prod-top{display:flex;gap:16px;align-items:center}
.prod-thumb{width:64px;height:64px;border-radius:12px;object-fit:cover;background:var(--pp);flex-shrink:0}
.prod-thumb-ph{width:64px;height:64px;border-radius:12px;background:var(--pp);display:flex;align-items:center;justify-content:center;font-size:1.5rem;flex-shrink:0}
.prod-info{flex:1;min-width:0}
.prod-title{font-weight:700;font-size:.92rem;margin-bottom:2px}
.prod-meta{font-size:.75rem;color:var(--txl)}
.prod-meta b{color:var(--p)}
.prod-actions{display:flex;gap:8px;flex-shrink:0}

/* IMAGE GALLERY IN EDIT */
.img-gallery{margin-top:14px;padding-top:14px;border-top:1px solid rgba(167,139,202,.1)}
.img-gallery-title{font-size:.82rem;font-weight:700;color:var(--txl);margin-bottom:10px}
.img-grid{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
.img-slot{position:relative;width:90px;height:90px;border-radius:12px;overflow:hidden;background:var(--pp);border:2px solid transparent;transition:all .3s;cursor:pointer}
.img-slot img{width:100%;height:100%;object-fit:cover}
.img-slot.default{border-color:var(--p);box-shadow:0 2px 10px rgba(167,139,202,.25)}
.img-slot .img-badge{position:absolute;top:4px;left:4px;padding:2px 6px;background:var(--p);color:var(--w);border-radius:6px;font-size:.55rem;font-weight:800;letter-spacing:.5px}
.img-slot .img-remove{position:absolute;top:4px;right:4px;width:20px;height:20px;background:rgba(229,57,53,.85);color:var(--w);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.65rem;cursor:pointer;opacity:0;transition:opacity .2s}
.img-slot:hover .img-remove{opacity:1}
.img-slot .img-set-default{position:absolute;bottom:4px;left:50%;transform:translateX(-50%);padding:2px 8px;background:rgba(255,255,255,.9);border-radius:6px;font-size:.55rem;font-weight:700;color:var(--p);opacity:0;transition:opacity .2s;white-space:nowrap;cursor:pointer}
.img-slot:hover .img-set-default{opacity:1}
.add-img-row{display:flex;gap:8px}
.add-img-row input{flex:1}
.add-img-row button{flex-shrink:0}

/* EDIT PANEL */
.edit-panel{display:none;margin-top:14px;padding-top:14px;border-top:1px solid rgba(167,139,202,.1)}
.edit-panel.open{display:block}
.edit-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.edit-grid .field-group{margin-bottom:8px}
.edit-actions{display:flex;gap:8px;margin-top:12px}

/* PREVIEW */
.preview{margin-top:16px;padding:16px;border:2px dashed var(--pl);border-radius:12px;display:none}
.preview.show{display:flex;gap:16px;align-items:center}
.preview img{width:80px;height:80px;border-radius:10px;object-fit:cover;background:var(--pp)}
.preview-info h4{font-size:.95rem;margin-bottom:4px}
.preview-info p{font-size:.8rem;color:var(--txl)}

.empty-msg{text-align:center;padding:40px;color:var(--txl);font-style:italic}

/* MODAL OVERLAY */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center;padding:20px}
.modal-overlay.open{display:flex}
.modal{background:var(--w);border-radius:20px;padding:32px;max-width:600px;width:100%;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.15)}
.modal h2{font-family:'DM Serif Display',serif;font-size:1.4rem;margin-bottom:16px}
.modal-close{position:absolute;top:16px;right:16px;width:32px;height:32px;background:var(--pp);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:.9rem}

/* TAG TOGGLES */
.tag-toggle{cursor:pointer;display:inline-flex}
.tag-toggle input{display:none}
.tag-pill{padding:8px 16px;border-radius:20px;font-size:.78rem;font-weight:700;border:2px solid var(--pl);color:var(--txl);transition:all .3s;user-select:none}
.tag-toggle input:checked+.tag-new-pill{background:#e8f5e9;border-color:#48c78e;color:#2e7d32}
.tag-toggle input:checked+.tag-best-pill{background:#fff3e0;border-color:#ffb74d;color:#e65100}
.tag-pill:hover{transform:scale(1.05)}

/* UPLOAD */
.upload-area{position:relative}
.upload-zone{border:2px dashed var(--pl);border-radius:14px;padding:20px;text-align:center;transition:all .3s;background:var(--pp)}
.upload-zone.dragover{border-color:var(--p);background:rgba(201,179,232,.18);transform:scale(1.01)}
.upload-icon{font-size:2rem;margin-bottom:6px}
.upload-text{font-size:.82rem;color:var(--txl);margin-bottom:10px}
.upload-btn-label{display:inline-flex;align-items:center;gap:4px;cursor:pointer;margin-bottom:0}
.upload-or{font-size:.72rem;color:var(--pl);margin:10px 0 6px}
.upload-zone input[type=url]{background:var(--w);border:2px solid rgba(167,139,202,.12);border-radius:10px;padding:10px 14px;width:100%;font-size:.85rem}
.upload-preview{position:relative;display:inline-block;margin-top:10px}
.upload-preview img{width:120px;height:120px;object-fit:cover;border-radius:14px;border:3px solid var(--p);box-shadow:0 4px 16px rgba(167,139,202,.2)}
.img-remove-btn{position:absolute;top:-8px;right:-8px;background:var(--red);color:var(--w);border:none;border-radius:50px;padding:4px 10px;font-size:.7rem;font-weight:800;cursor:pointer;font-family:'Nunito',sans-serif;box-shadow:0 2px 8px rgba(229,57,53,.3)}
.upload-file-label{display:inline-flex;align-items:center;gap:4px;cursor:pointer}
.upload-progress{margin-top:8px;font-size:.78rem;color:var(--p);font-weight:700;display:none}
.upload-progress.show{display:block}

/* PROGRESS BAR */
.progress-bar-outer{height:12px;background:var(--pp);border-radius:8px;overflow:hidden;margin-bottom:10px}
.progress-bar-inner{height:100%;background:linear-gradient(135deg,var(--p),var(--pd));border-radius:8px;width:0%;transition:width .5s ease}
.progress-stats{font-size:.85rem;font-weight:700;color:var(--tx);margin-bottom:4px}
.progress-stats span{margin-right:16px}
.progress-stats .imported{color:var(--green)}
.progress-stats .skipped{color:#ff9800}
.progress-stats .failed{color:var(--red)}
.progress-message{font-size:.8rem;color:var(--txl)}

/* QR MODAL */
.qr-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(6px);z-index:300;display:none;align-items:center;justify-content:center;padding:20px}
.qr-overlay.open{display:flex}
.qr-modal{background:var(--w);border-radius:20px;padding:32px;text-align:center;max-width:400px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.2)}
.qr-modal h3{font-family:'DM Serif Display',serif;font-size:1.2rem;margin-bottom:8px}
.qr-modal p{font-size:.82rem;color:var(--txl);margin-bottom:16px;word-break:break-all}
.qr-modal img{margin:0 auto 16px;border-radius:12px;border:3px solid var(--pp)}
.qr-actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
.qr-close{position:absolute;top:-12px;right:-12px;width:36px;height:36px;background:var(--p);color:var(--w);border:none;border-radius:50%;font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center}

@media(max-width:600px){.form-row{flex-direction:column}.edit-grid{grid-template-columns:1fr}.prod-actions{flex-direction:column}.img-slot{width:72px;height:72px}}
</style>
</head>
<body>

<nav><div class="nav-inner">
  <a href="/admin" class="logo">Shukarsh<span>‚úø</span> Admin</a>
  <div style="display:flex;gap:10px;align-items:center">
    <a href="/" class="back-btn">‚Üê View Site</a>
    <a href="/admin/analytics" class="back-btn" style="background:#e8ddf5;color:#a78bca;border-color:#c9b3e8">üìä Analytics</a>
    <a href="/admin/logout" class="back-btn" style="background:#fce4ec;color:#c62828;border-color:#f8bbd0">üö™ Logout</a>
  </div>
</div></nav>

<div class="container">
  <h1>Manage <i>Products</i> ‚úø</h1>
  <p class="subtitle">Add, edit images & details for your products</p>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('url')">üîó From URL</div>
    <div class="tab" onclick="switchTab('manual')">‚úèÔ∏è Manual Entry</div>
    <div class="tab" onclick="switchTab('bulk')">üì¶ Bulk Import</div>
  </div>

  <div class="add-box">
    <div class="panel active" id="panel-url">
      <h2>üîó Paste Product URL</h2>
      <p class="hint">‚ö†Ô∏è Some sites block auto-fetch. Use Manual Entry if needed.</p>
      <form id="urlForm" class="form-row" style="margin-top:14px">
        <input type="url" id="urlInput" placeholder="https://www.meesho.com/product/..." required>
        <button type="submit" class="btn" id="urlBtn">‚úø Fetch</button>
      </form>
      <div class="msg" id="urlMsg"></div>
    </div>

    <div class="panel" id="panel-manual">
      <h2>‚úèÔ∏è Add Product Manually</h2>
      <form id="manualForm">
        <div class="form-row">
          <div class="field-group" style="flex:2"><label class="field-label">Product Title *</label>
            <input type="text" name="title" placeholder="e.g. Silicon Spatula Set" required></div>
          <div class="field-group" style="flex:1"><label class="field-label">Platform</label>
            <select name="platform"><option value="Meesho">Meesho</option><option value="Amazon">Amazon</option><option value="Flipkart">Flipkart</option><option value="Other">Other</option></select></div>
        </div>
        <div class="form-row">
          <div class="field-group" style="flex:1"><label class="field-label">Price</label>
            <input type="text" name="price" placeholder="‚Çπ299"></div>
          <div class="field-group" style="flex:1"><label class="field-label">Original Price</label>
            <input type="text" name="original_price" placeholder="‚Çπ599"></div>
          <div class="field-group" style="flex:1"><label class="field-label">Rating</label>
            <input type="text" name="rating" placeholder="4.2"></div>
        </div>
        <div class="form-row">
          <div class="field-group" style="flex:1"><label class="field-label">Category</label>
            <select name="category"><option value="">Auto-detect</option><option value="Nails & Beauty">Nails & Beauty</option><option value="Caps & Accessories">Caps & Accessories</option><option value="Fashion & Clothing">Fashion & Clothing</option><option value="Home & Decor">Home & Decor</option><option value="Kitchen & Dining">Kitchen & Dining</option><option value="Electronics">Electronics</option><option value="Other">Other</option></select></div>
        </div>
        <div class="field-group"><label class="field-label">Product URL</label>
          <input type="url" name="url" placeholder="https://www.meesho.com/..."></div>
        <div class="field-group"><label class="field-label">Main Image</label>
          <div class="upload-area" id="manual-upload-area">
            <div class="upload-zone" id="manual-drop-zone">
              <div class="upload-icon">üì∏</div>
              <div class="upload-text">Drag & drop image here or</div>
              <label class="btn btn-sm btn-outline upload-btn-label">
                üìÅ Choose File
                <input type="file" accept="image/*" id="manual-file-input" style="display:none" onchange="handleManualFileSelect(this)">
              </label>
              <div class="upload-or">‚Äî or paste URL ‚Äî</div>
              <input type="url" name="image_url" id="manual-image-url" placeholder="https://... image URL">
            </div>
            <div class="upload-preview" id="manual-upload-preview" style="display:none">
              <img id="manual-preview-img">
              <button type="button" class="img-remove-btn" onclick="clearManualUpload()">‚úï Remove</button>
            </div>
          </div></div>
        <div class="field-group"><label class="field-label">Description</label>
          <textarea name="description" placeholder="Short description..."></textarea></div>
        <button type="submit" class="btn">‚úø Add Product</button>
      </form>
      <div class="msg" id="manualMsg"></div>
    </div>

    <div class="panel" id="panel-bulk">
      <h2>üì¶ Bulk Import from Meesho</h2>
      <p class="hint">üöÄ Import all products from your Meesho store in one click. Duplicates are automatically skipped.</p>
      <div style="margin-top:16px">
        <div class="form-row">
          <input type="url" id="storeUrl" value="https://www.meesho.com/ShuKarshEnterprises" placeholder="Meesho store URL">
          <button class="btn" id="bulkBtn" onclick="startBulkImport()">üöÄ Import All</button>
        </div>
        <div id="bulkProgress" style="display:none;margin-top:16px">
          <div class="progress-bar-outer">
            <div class="progress-bar-inner" id="bulkProgressBar"></div>
          </div>
          <div class="progress-stats" id="bulkStats"></div>
          <div class="progress-message" id="bulkMessage"></div>
        </div>
        <div class="msg" id="bulkMsg"></div>
        <div style="margin-top:20px;padding-top:16px;border-top:1px solid rgba(167,139,202,.1)">
          <h3 style="font-size:.95rem;font-weight:700;color:var(--txl);margin-bottom:8px">üìã Or paste JSON data</h3>
          <p class="hint">If auto-import fails (Meesho blocks), you can paste product data as JSON here.</p>
          <textarea id="jsonImport" rows="4" placeholder='[{"name":"Product","price":299,...}]' style="margin-top:8px"></textarea>
          <button class="btn btn-sm" onclick="importJSON()" style="margin-top:8px">üì• Import JSON</button>
          <div class="msg" id="jsonMsg"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="prod-list">
    <h2>üì¶ Your Products ({{len .Products}})</h2>
    {{if .Products}}
      {{range .Products}}
      <div class="prod-card" id="prod-{{.ID}}" data-id="{{.ID}}">
        <div class="prod-top">
          {{if .ImageUrl}}<img class="prod-thumb" src="/img?url={{.ImageUrl}}" onerror="this.outerHTML='<div class=prod-thumb-ph>üì¶</div>'">{{else}}<div class="prod-thumb-ph">üì¶</div>{{end}}
          <div class="prod-info">
            <div class="prod-title">{{.Title}}</div>
            <div class="prod-meta"><b>{{.Platform}}</b> ¬∑ {{if .Price}}{{.Price}}{{else}}No price{{end}} ¬∑ {{if .Category}}{{.Category}}{{else}}Uncategorized{{end}}</div>
          </div>
          <div class="prod-actions">
            <button class="btn btn-sm btn-outline" onclick="showQR({{.ID}}, '{{.Title}}')" title="QR Code">üì± QR</button>
            <button class="btn btn-sm btn-outline" onclick="toggleEdit({{.ID}})">‚úèÔ∏è Edit</button>
            <button class="btn btn-sm btn-danger" onclick="delProduct({{.ID}})">üóë</button>
          </div>
        </div>

        <!-- EDIT PANEL (hidden by default) -->
        <div class="edit-panel" id="edit-{{.ID}}">
          <!-- IMAGE GALLERY -->
          <div class="img-gallery">
            <div class="img-gallery-title">üñºÔ∏è Product Images <span style="font-weight:400;color:var(--txl)">(click to set as default)</span></div>
            <div class="img-grid" id="imgs-{{.ID}}"></div>
            <div class="add-img-row">
              <input type="url" id="newimg-{{.ID}}" placeholder="Paste image URL...">
              <button class="btn btn-sm" onclick="addImage({{.ID}})">+ URL</button>
              <label class="btn btn-sm btn-outline upload-file-label">
                üì∑ Upload
                <input type="file" accept="image/*" style="display:none" onchange="handleEditFileUpload(this, {{.ID}})">
              </label>
            </div>
          </div>

          <!-- EDIT FIELDS -->
          <div style="margin-top:16px">
            <div class="img-gallery-title">üìù Product Details</div>
            <div class="edit-grid">
              <div class="field-group"><label class="field-label">Title</label>
                <input type="text" id="ed-title-{{.ID}}" value="{{.Title}}"></div>
              <div class="field-group"><label class="field-label">Price</label>
                <input type="text" id="ed-price-{{.ID}}" value="{{.Price}}"></div>
              <div class="field-group"><label class="field-label">Original Price</label>
                <input type="text" id="ed-origprice-{{.ID}}" value="{{.OriginalPrice}}"></div>
              <div class="field-group"><label class="field-label">Rating</label>
                <input type="text" id="ed-rating-{{.ID}}" value="{{.Rating}}"></div>
              <div class="field-group"><label class="field-label">Category</label>
                <select id="ed-cat-{{.ID}}">
                  <option value="Nails & Beauty" {{if eq .Category "Nails & Beauty"}}selected{{end}}>Nails & Beauty</option>
                  <option value="Caps & Accessories" {{if eq .Category "Caps & Accessories"}}selected{{end}}>Caps & Accessories</option>
                  <option value="Fashion & Clothing" {{if eq .Category "Fashion & Clothing"}}selected{{end}}>Fashion & Clothing</option>
                  <option value="Home & Decor" {{if eq .Category "Home & Decor"}}selected{{end}}>Home & Decor</option>
                  <option value="Kitchen & Dining" {{if eq .Category "Kitchen & Dining"}}selected{{end}}>Kitchen & Dining</option>
                  <option value="Electronics" {{if eq .Category "Electronics"}}selected{{end}}>Electronics</option>
                  <option value="Other" {{if eq .Category "Other"}}selected{{end}}>Other</option>
                </select></div>
              <div class="field-group"><label class="field-label">Platform</label>
                <select id="ed-platform-{{.ID}}">
                  <option value="Meesho" {{if eq .Platform "Meesho"}}selected{{end}}>Meesho</option>
                  <option value="Amazon" {{if eq .Platform "Amazon"}}selected{{end}}>Amazon</option>
                  <option value="Flipkart" {{if eq .Platform "Flipkart"}}selected{{end}}>Flipkart</option>
                  <option value="Other" {{if eq .Platform "Other"}}selected{{end}}>Other</option>
                </select></div>
            </div>
            <div style="display:flex;gap:16px;margin:10px 0">
              <label class="tag-toggle" title="Show in New Arrivals">
                <input type="checkbox" id="ed-new-{{.ID}}" {{if .IsNew}}checked{{end}}>
                <span class="tag-pill tag-new-pill">‚ú® New Arrival</span>
              </label>
              <label class="tag-toggle" title="Show in Best Sellers">
                <input type="checkbox" id="ed-best-{{.ID}}" {{if .IsBestseller}}checked{{end}}>
                <span class="tag-pill tag-best-pill">üî• Best Seller</span>
              </label>
            </div>
            <div class="field-group"><label class="field-label">Product URL</label>
              <input type="url" id="ed-url-{{.ID}}" value="{{.Url}}"></div>
            <div class="field-group"><label class="field-label">Description (shows on product page)</label>
              <textarea id="ed-desc-{{.ID}}" rows="3">{{.LongDescription}}</textarea></div>
          </div>

          <div class="edit-actions">
            <button class="btn" onclick="saveProduct({{.ID}})">üíæ Save Changes</button>
            <button class="btn btn-sm btn-outline" onclick="toggleEdit({{.ID}})">Cancel</button>
          </div>
          <div class="msg" id="editmsg-{{.ID}}"></div>
        </div>
      </div>
      {{end}}
    {{else}}
      <div class="empty-msg">No products yet. Add your first one! üå∏</div>
    {{end}}
  </div>
</div>

<!-- QR Code Modal -->
<div class="qr-overlay" id="qrOverlay" onclick="if(event.target===this)closeQR()">
  <div class="qr-modal" style="position:relative">
    <button class="qr-close" onclick="closeQR()">‚úï</button>
    <h3 id="qrTitle">QR Code</h3>
    <p id="qrUrl"></p>
    <img id="qrImage" width="256" height="256" alt="QR Code">
    <div class="qr-actions">
      <a id="qrDownload" class="btn btn-sm" download="qr-code.png">üíæ Download PNG</a>
      <button class="btn btn-sm btn-outline" onclick="copyQRUrl()">üìã Copy URL</button>
      <button class="btn btn-sm btn-outline" onclick="printQR()">üñ®Ô∏è Print</button>
    </div>
  </div>
</div>

<script>
// Tab switching
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('panel-' + tab).classList.add('active');
}

// Track images per product: { productId: { images: [...urls], defaultUrl: '...' } }
const productData = {};

// Initialize product image data from server
async function initProductImages() {
  const res = await fetch('/api/products');
  const products = await res.json();
  products.forEach(p => {
    let imgs = [];
    try { imgs = JSON.parse(p.images || '[]'); } catch(e) {}
    // Deduplicate by base URL (ignore ?width= params)
    const seen = new Set();
    const unique = [];
    imgs.forEach(url => {
      const base = url.split('?')[0];
      if (!seen.has(base)) { seen.add(base); unique.push(url); }
    });
    // If main image not in list, add it first
    if (p.image_url && !unique.some(u => u.split('?')[0] === p.image_url.split('?')[0])) {
      unique.unshift(p.image_url);
    }
    productData[p.id] = { images: unique, defaultUrl: p.image_url };
    renderImageGrid(p.id);
  });
}

function renderImageGrid(id) {
  const grid = document.getElementById('imgs-' + id);
  if (!grid) return;
  const data = productData[id];
  if (!data) return;
  
  grid.innerHTML = '';
  if (data.images.length === 0) {
    grid.innerHTML = '<div style="font-size:.82rem;color:var(--txl);padding:8px 0">No images yet. Add one below!</div>';
    return;
  }
  
  data.images.forEach((url, i) => {
    const isDefault = url.split('?')[0] === (data.defaultUrl || '').split('?')[0];
    const slot = document.createElement('div');
    slot.className = 'img-slot' + (isDefault ? ' default' : '');
    const imgSrc = url.startsWith('/uploads/') ? url : '/img?url=' + encodeURIComponent(url);
    slot.innerHTML = `
      <img src="${imgSrc}" onerror="this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 1 1\"><rect fill=\"%23f0eaf8\"/></svg>'">
      ${isDefault ? '<div class="img-badge">DEFAULT</div>' : ''}
      <div class="img-remove" onclick="event.stopPropagation();removeImage(${id},${i})">‚úï</div>
      ${!isDefault ? '<div class="img-set-default" onclick="event.stopPropagation();setDefault('+id+','+i+')">Set Default</div>' : ''}
    `;
    if (!isDefault) {
      slot.addEventListener('click', () => setDefault(id, i));
    }
    grid.appendChild(slot);
  });
}

function addImage(id) {
  const input = document.getElementById('newimg-' + id);
  const url = input.value.trim();
  if (!url) return;
  if (!productData[id]) productData[id] = { images: [], defaultUrl: '' };
  productData[id].images.push(url);
  // If no default set, make this the default
  if (!productData[id].defaultUrl) {
    productData[id].defaultUrl = url;
  }
  input.value = '';
  renderImageGrid(id);
}

function removeImage(id, index) {
  const data = productData[id];
  if (!data) return;
  const removed = data.images.splice(index, 1)[0];
  // If removed was default, set first remaining as default
  if (removed.split('?')[0] === (data.defaultUrl || '').split('?')[0]) {
    data.defaultUrl = data.images[0] || '';
  }
  renderImageGrid(id);
}

function setDefault(id, index) {
  const data = productData[id];
  if (!data || !data.images[index]) return;
  data.defaultUrl = data.images[index];
  // Move default to first position
  const img = data.images.splice(index, 1)[0];
  data.images.unshift(img);
  renderImageGrid(id);
}

function toggleEdit(id) {
  const panel = document.getElementById('edit-' + id);
  panel.classList.toggle('open');
}

async function saveProduct(id) {
  const msg = document.getElementById('editmsg-' + id);
  msg.className = 'msg loading'; msg.textContent = 'Saving...';
  
  const data = productData[id] || { images: [], defaultUrl: '' };
  const fd = new FormData();
  fd.append('title', document.getElementById('ed-title-' + id).value);
  fd.append('price', document.getElementById('ed-price-' + id).value);
  fd.append('original_price', document.getElementById('ed-origprice-' + id).value);
  fd.append('rating', document.getElementById('ed-rating-' + id).value);
  fd.append('category', document.getElementById('ed-cat-' + id).value);
  fd.append('platform', document.getElementById('ed-platform-' + id).value);
  fd.append('url', document.getElementById('ed-url-' + id).value);
  fd.append('long_description', document.getElementById('ed-desc-' + id).value);
  fd.append('image_url', data.defaultUrl || '');
  fd.append('images', JSON.stringify(data.images));
  fd.append('is_new', document.getElementById('ed-new-' + id).checked ? '1' : '0');
  fd.append('is_bestseller', document.getElementById('ed-best-' + id).checked ? '1' : '0');
  
  try {
    const res = await fetch('/api/update/' + id, { method: 'POST', body: fd });
    const result = await res.json();
    if (result.error) throw new Error(result.error);
    msg.className = 'msg ok'; msg.textContent = '‚úÖ Saved!';
    // Update thumbnail
    const thumb = document.querySelector('#prod-' + id + ' .prod-thumb');
    if (thumb && data.defaultUrl) thumb.src = '/img?url=' + encodeURIComponent(data.defaultUrl);
    // Update title & meta
    const titleEl = document.querySelector('#prod-' + id + ' .prod-title');
    if (titleEl) titleEl.textContent = document.getElementById('ed-title-' + id).value;
    setTimeout(() => { msg.style.display = 'none'; }, 2000);
  } catch(err) {
    msg.className = 'msg err'; msg.textContent = '‚ùå ' + err.message;
  }
}

async function delProduct(id) {
  if (!confirm('Delete this product?')) return;
  await fetch('/api/delete/' + id, { method: 'POST' });
  document.getElementById('prod-' + id)?.remove();
}

// URL form
document.getElementById('urlForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const btn = document.getElementById('urlBtn');
  const msg = document.getElementById('urlMsg');
  const url = document.getElementById('urlInput').value.trim();
  btn.disabled = true; btn.textContent = '‚è≥ Fetching...';
  msg.className = 'msg loading'; msg.textContent = 'üîç Scraping...';
  try {
    const fd = new FormData(); fd.append('url', url); fd.append('mode', 'url');
    const res = await fetch('/api/add', { method: 'POST', body: fd });
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    msg.className = 'msg ok'; msg.textContent = '‚úÖ Added: ' + (data.product?.title || 'Product');
    setTimeout(() => location.reload(), 1000);
  } catch(err) { msg.className = 'msg err'; msg.textContent = '‚ùå ' + err.message; }
  btn.disabled = false; btn.textContent = '‚úø Fetch';
});

// Manual form
document.getElementById('manualForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const msg = document.getElementById('manualMsg');
  const fd = new FormData(e.target); fd.append('mode', 'manual');
  msg.className = 'msg loading'; msg.textContent = 'Adding...';
  try {
    const res = await fetch('/api/add', { method: 'POST', body: fd });
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    msg.className = 'msg ok'; msg.textContent = '‚úÖ Added: ' + (data.product?.title || 'Product');
    setTimeout(() => location.reload(), 1000);
  } catch(err) { msg.className = 'msg err'; msg.textContent = '‚ùå ' + err.message; }
});

// === FILE UPLOAD FUNCTIONS ===

// Upload a file to server, returns the URL
async function uploadFile(file) {
  const fd = new FormData();
  fd.append('file', file);
  const res = await fetch('/api/upload', { method: 'POST', body: fd });
  const data = await res.json();
  if (data.error) throw new Error(data.error);
  return data.url;
}

// Manual entry: file select
async function handleManualFileSelect(input) {
  const file = input.files[0];
  if (!file) return;
  const zone = document.getElementById('manual-drop-zone');
  const preview = document.getElementById('manual-upload-preview');
  const previewImg = document.getElementById('manual-preview-img');
  const urlInput = document.getElementById('manual-image-url');
  
  zone.innerHTML = '<div class="upload-progress show">‚è≥ Uploading...</div>';
  try {
    const url = await uploadFile(file);
    urlInput.value = url;
    previewImg.src = url;
    preview.style.display = 'inline-block';
    zone.innerHTML = `<div class="upload-icon">‚úÖ</div><div class="upload-text">Image uploaded!</div>
      <label class="btn btn-sm btn-outline upload-btn-label">üìÅ Change File<input type="file" accept="image/*" id="manual-file-input" style="display:none" onchange="handleManualFileSelect(this)"></label>
      <div class="upload-or">‚Äî or paste URL ‚Äî</div>
      <input type="url" name="image_url" id="manual-image-url" placeholder="https://... image URL" value="${url}">`;
  } catch(err) {
    zone.innerHTML = `<div class="upload-icon">‚ùå</div><div class="upload-text">${err.message}</div>
      <label class="btn btn-sm btn-outline upload-btn-label">üìÅ Try Again<input type="file" accept="image/*" id="manual-file-input" style="display:none" onchange="handleManualFileSelect(this)"></label>
      <div class="upload-or">‚Äî or paste URL ‚Äî</div>
      <input type="url" name="image_url" id="manual-image-url" placeholder="https://... image URL">`;
  }
}

function clearManualUpload() {
  const preview = document.getElementById('manual-upload-preview');
  const urlInput = document.getElementById('manual-image-url');
  preview.style.display = 'none';
  if (urlInput) urlInput.value = '';
}

// Drag & drop for manual entry
document.addEventListener('DOMContentLoaded', () => {
  const zone = document.getElementById('manual-drop-zone');
  if (!zone) return;
  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
  zone.addEventListener('drop', async e => {
    e.preventDefault(); zone.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
      // Create a fake input to reuse the handler
      const dt = new DataTransfer(); dt.items.add(file);
      const fakeInput = document.createElement('input'); fakeInput.type = 'file'; fakeInput.files = dt.files;
      await handleManualFileSelect(fakeInput);
    }
  });
});

// Edit panel: upload file for existing product
async function handleEditFileUpload(input, id) {
  const file = input.files[0];
  if (!file) return;
  // Show loading in the add-img row
  const row = input.closest('.add-img-row');
  const origHTML = row.innerHTML;
  row.innerHTML = '<span class="upload-progress show">‚è≥ Uploading image...</span>';
  try {
    const url = await uploadFile(file);
    if (!productData[id]) productData[id] = { images: [], defaultUrl: '' };
    productData[id].images.push(url);
    if (!productData[id].defaultUrl) productData[id].defaultUrl = url;
    renderImageGrid(id);
    row.innerHTML = origHTML;
    // Reset the file input
    row.querySelector('input[type=file]').value = '';
  } catch(err) {
    row.innerHTML = origHTML;
    alert('Upload failed: ' + err.message);
  }
}

// === BULK IMPORT ===
async function startBulkImport() {
  const btn = document.getElementById('bulkBtn');
  const msg = document.getElementById('bulkMsg');
  const progress = document.getElementById('bulkProgress');
  const storeUrl = document.getElementById('storeUrl').value.trim();
  
  btn.disabled = true; btn.textContent = '‚è≥ Importing...';
  msg.className = 'msg'; msg.style.display = 'none';
  progress.style.display = 'block';
  
  try {
    const fd = new FormData();
    fd.append('store_url', storeUrl);
    const res = await fetch('/api/bulk-import', { method: 'POST', body: fd });
    const data = await res.json();
    if (data.error) { msg.className = 'msg err'; msg.textContent = '‚ùå ' + data.error; return; }
    
    // Poll for status
    pollImportStatus();
  } catch(err) {
    msg.className = 'msg err'; msg.textContent = '‚ùå ' + err.message;
    btn.disabled = false; btn.textContent = 'üöÄ Import All';
  }
}

async function pollImportStatus() {
  const bar = document.getElementById('bulkProgressBar');
  const stats = document.getElementById('bulkStats');
  const message = document.getElementById('bulkMessage');
  const msg = document.getElementById('bulkMsg');
  const btn = document.getElementById('bulkBtn');
  
  try {
    const res = await fetch('/api/bulk-import/status');
    const data = await res.json();
    
    const total = data.total || 1;
    const done = (data.imported || 0) + (data.skipped || 0) + (data.failed || 0);
    const pct = total > 0 ? Math.round((done / total) * 100) : 0;
    bar.style.width = pct + '%';
    
    stats.innerHTML = `<span class="imported">‚úÖ ${data.imported || 0} imported</span>` +
      `<span class="skipped">‚è≠ ${data.skipped || 0} skipped</span>` +
      `<span class="failed">‚ùå ${data.failed || 0} failed</span>` +
      `<span>of ${data.total || '?'} total</span>`;
    message.textContent = data.message || '';
    
    if (data.running) {
      setTimeout(pollImportStatus, 1000);
    } else {
      btn.disabled = false; btn.textContent = 'üöÄ Import All';
      if (data.imported > 0) {
        msg.className = 'msg ok';
        msg.textContent = `üéâ Done! Imported ${data.imported} new products.`;
        setTimeout(() => location.reload(), 2000);
      } else if (data.errors && data.errors.length > 0) {
        msg.className = 'msg err';
        msg.textContent = '‚ö†Ô∏è ' + data.errors[0];
      } else {
        msg.className = 'msg ok';
        msg.textContent = '‚úÖ All products already imported!';
      }
    }
  } catch(err) {
    setTimeout(pollImportStatus, 2000);
  }
}

async function importJSON() {
  const msg = document.getElementById('jsonMsg');
  const textarea = document.getElementById('jsonImport');
  const jsonStr = textarea.value.trim();
  if (!jsonStr) { msg.className = 'msg err'; msg.textContent = 'Paste JSON data first'; return; }
  
  msg.className = 'msg loading'; msg.textContent = 'Importing...';
  try {
    const res = await fetch('/api/bulk-import/json', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: jsonStr
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    msg.className = 'msg ok';
    msg.textContent = `üéâ Imported ${data.imported}, skipped ${data.skipped} (of ${data.total})`;
    if (data.imported > 0) setTimeout(() => location.reload(), 2000);
  } catch(err) {
    msg.className = 'msg err'; msg.textContent = '‚ùå ' + err.message;
  }
}

// === QR CODE ===
function showQR(productId, title) {
  const baseUrl = window.location.origin;
  const productUrl = baseUrl + '/product/' + productId;
  const qrApiUrl = '/api/qr?url=' + encodeURIComponent(productUrl) + '&size=256';
  
  document.getElementById('qrTitle').textContent = title || 'Product QR';
  document.getElementById('qrUrl').textContent = productUrl;
  document.getElementById('qrImage').src = qrApiUrl;
  document.getElementById('qrDownload').href = qrApiUrl;
  document.getElementById('qrDownload').download = 'qr-' + productId + '.png';
  document.getElementById('qrOverlay').classList.add('open');
}

function closeQR() {
  document.getElementById('qrOverlay').classList.remove('open');
}

function copyQRUrl() {
  const url = document.getElementById('qrUrl').textContent;
  navigator.clipboard.writeText(url).then(() => {
    const btn = event.target;
    btn.textContent = '‚úÖ Copied!';
    setTimeout(() => btn.textContent = 'üìã Copy URL', 1500);
  });
}

function printQR() {
  const img = document.getElementById('qrImage');
  const title = document.getElementById('qrTitle').textContent;
  const url = document.getElementById('qrUrl').textContent;
  const w = window.open('', '_blank');
  w.document.write(`<html><head><title>QR - ${title}</title>
    <style>body{font-family:sans-serif;text-align:center;padding:40px}
    h2{margin-bottom:8px}p{color:#666;font-size:14px;word-break:break-all}
    img{margin:20px auto;display:block}
    .brand{font-size:24px;color:#a78bca;margin-bottom:20px}</style></head>
    <body><div class="brand">Shukarsh ‚úø</div>
    <h2>${title}</h2><img src="${img.src}" width="300" height="300">
    <p>${url}</p><p style="margin-top:20px;font-size:12px;color:#999">Scan to view product</p></body></html>`);
  w.document.close();
  setTimeout(() => { w.print(); }, 500);
}

// Initialize
initProductImages();
</script>
</body>
</html>
